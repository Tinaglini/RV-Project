<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ClienteService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Sistema Clientes RV</a> &gt; <a href="index.source.html" class="el_package">app.sistemaclientesrv.service</a> &gt; <span class="el_source">ClienteService.java</span></div><h1>ClienteService.java</h1><pre class="source lang-java linenums">package app.sistemaclientesrv.service;

import app.sistemaclientesrv.entity.Cliente;
import app.sistemaclientesrv.entity.Categoria;
import app.sistemaclientesrv.repository.ClienteRepository;
import app.sistemaclientesrv.repository.CategoriaRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

@Service
@Transactional
<span class="fc" id="L18">public class ClienteService {</span>

    @Autowired
    private ClienteRepository clienteRepository;

    @Autowired
    private CategoriaRepository categoriaRepository;

<span class="fc" id="L26">    private final BCryptPasswordEncoder passwordEncoder = new BCryptPasswordEncoder();</span>

    public Cliente salvar(Cliente cliente) {
        // REGRA OBRIGATÓRIA 1: Exception - CPF único
<span class="fc bfc" id="L30" title="All 2 branches covered.">        if (clienteRepository.existsByCpf(cliente.getCpf())) {</span>
<span class="fc" id="L31">            throw new RuntimeException(&quot;Não é possível cadastrar cliente com CPF já existente&quot;);</span>
        }

        // NOVA REGRA: Email único (se informado)
<span class="pc bpc" id="L35" title="2 of 4 branches missed.">        if (cliente.getEmail() != null &amp;&amp; !cliente.getEmail().trim().isEmpty()) {</span>
<span class="fc" id="L36">            Optional&lt;Cliente&gt; clienteExistente = clienteRepository.findByEmail(cliente.getEmail());</span>
<span class="fc bfc" id="L37" title="All 2 branches covered.">            if (clienteExistente.isPresent()) {</span>
<span class="fc" id="L38">                throw new RuntimeException(&quot;Já existe um cliente cadastrado com este email&quot;);</span>
            }
        }

        // NOVA REGRA: Validação e criptografia da senha
<span class="pc bpc" id="L43" title="1 of 4 branches missed.">        if (cliente.getSenha() == null || cliente.getSenha().trim().isEmpty()) {</span>
<span class="fc" id="L44">            throw new RuntimeException(&quot;A senha é obrigatória para cadastro do cliente&quot;);</span>
        }

<span class="fc bfc" id="L47" title="All 2 branches covered.">        if (cliente.getSenha().length() &lt; 6) {</span>
<span class="fc" id="L48">            throw new RuntimeException(&quot;A senha deve ter no mínimo 6 caracteres&quot;);</span>
        }

        // Criptografar a senha antes de salvar
<span class="fc" id="L52">        String senhaHash = passwordEncoder.encode(cliente.getSenha());</span>
<span class="fc" id="L53">        cliente.setSenhaHash(senhaHash);</span>
        // Não limpar a senha aqui pois pode causar problemas de validação

        // REGRA OBRIGATÓRIA 2: Modificação do objeto - Status automático
<span class="pc bpc" id="L57" title="1 of 4 branches missed.">        if (cliente.getTelefone() == null || cliente.getTelefone().trim().isEmpty()) {</span>
<span class="fc" id="L58">            cliente.setStatusCadastro(&quot;INCOMPLETO&quot;);</span>
        } else {
<span class="fc" id="L60">            cliente.setStatusCadastro(&quot;COMPLETO&quot;);</span>
        }

        // Categoria padrão se não informada
<span class="fc bfc" id="L64" title="All 2 branches covered.">        if (cliente.getCategoria() == null) {</span>
<span class="fc" id="L65">            Categoria categoriaPF = categoriaRepository.findByNome(&quot;PESSOA_FISICA&quot;).orElse(null);</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">            if (categoriaPF != null) {</span>
<span class="fc" id="L67">                cliente.setCategoria(categoriaPF);</span>
            }
        }

<span class="fc" id="L71">        return clienteRepository.save(cliente);</span>
    }

    public Cliente buscarPorId(Long id) {
<span class="fc" id="L75">        return clienteRepository.findById(id)</span>
<span class="fc" id="L76">                .orElseThrow(() -&gt; new RuntimeException(&quot;Cliente não encontrado&quot;));</span>
    }

    public List&lt;Cliente&gt; listarTodos() {
<span class="fc" id="L80">        return clienteRepository.findAll();</span>
    }

    public Cliente atualizar(Long id, Cliente cliente) {
<span class="fc" id="L84">        Cliente clienteExistente = buscarPorId(id);</span>
<span class="fc" id="L85">        cliente.setId(id);</span>
<span class="fc" id="L86">        cliente.setUpdatedAt(LocalDateTime.now());</span>

        // Se uma nova senha foi fornecida, criptografar
<span class="pc bpc" id="L89" title="3 of 4 branches missed.">        if (cliente.getSenha() != null &amp;&amp; !cliente.getSenha().trim().isEmpty()) {</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (cliente.getSenha().length() &lt; 6) {</span>
<span class="nc" id="L91">                throw new RuntimeException(&quot;A senha deve ter no mínimo 6 caracteres&quot;);</span>
            }
<span class="nc" id="L93">            String senhaHash = passwordEncoder.encode(cliente.getSenha());</span>
<span class="nc" id="L94">            cliente.setSenhaHash(senhaHash);</span>
<span class="nc" id="L95">        } else {</span>
            // Manter a senha existente se não foi fornecida nova senha
<span class="fc" id="L97">            cliente.setSenhaHash(clienteExistente.getSenhaHash());</span>
        }

        // Aplicar regra de status na atualização
<span class="pc bpc" id="L101" title="2 of 4 branches missed.">        if (cliente.getTelefone() == null || cliente.getTelefone().trim().isEmpty()) {</span>
<span class="nc" id="L102">            cliente.setStatusCadastro(&quot;INCOMPLETO&quot;);</span>
        } else {
<span class="fc" id="L104">            cliente.setStatusCadastro(&quot;COMPLETO&quot;);</span>
        }

<span class="fc" id="L107">        return clienteRepository.save(cliente);</span>
    }

    public void deletar(Long id) {
<span class="fc" id="L111">        Cliente cliente = buscarPorId(id);</span>
<span class="fc" id="L112">        clienteRepository.delete(cliente);</span>
<span class="fc" id="L113">    }</span>

    public List&lt;Cliente&gt; buscarPorNome(String nome) {
<span class="fc" id="L116">        return clienteRepository.findByNomeContainingIgnoreCase(nome);</span>
    }

    public List&lt;Cliente&gt; buscarPorCategoria(Long categoriaId) {
<span class="fc" id="L120">        return clienteRepository.findByCategoriaId(categoriaId);</span>
    }

    public Cliente buscarPorCpf(String cpf) {
<span class="fc" id="L124">        return clienteRepository.findByCpf(cpf)</span>
<span class="fc" id="L125">                .orElseThrow(() -&gt; new RuntimeException(&quot;Cliente não encontrado com CPF: &quot; + cpf));</span>
    }

    // NOVOS MÉTODOS PARA AUTENTICAÇÃO

    /**
     * Realiza login do cliente com CPF/Email e senha
     */
    public Cliente autenticar(String loginCpfOuEmail, String senha) {
<span class="fc" id="L134">        Cliente cliente = buscarPorCpfOuEmail(loginCpfOuEmail);</span>

        // Verificar se a conta não está bloqueada
<span class="fc bfc" id="L137" title="All 2 branches covered.">        if (cliente.getContaBloqueada()) {</span>
<span class="fc" id="L138">            throw new RuntimeException(&quot;Conta bloqueada devido a muitas tentativas de login incorretas. Entre em contato com o suporte.&quot;);</span>
        }

        // Verificar se o cliente está ativo
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        if (!cliente.getAtivo()) {</span>
<span class="nc" id="L143">            throw new RuntimeException(&quot;Cliente inativo. Entre em contato com o suporte.&quot;);</span>
        }

        // Verificar a senha
<span class="fc bfc" id="L147" title="All 2 branches covered.">        if (!passwordEncoder.matches(senha, cliente.getSenhaHash())) {</span>
<span class="fc" id="L148">            cliente.registrarTentativaLogin();</span>
<span class="fc" id="L149">            clienteRepository.save(cliente);</span>
<span class="fc" id="L150">            throw new RuntimeException(&quot;Senha incorreta&quot;);</span>
        }

        // Login bem-sucedido
<span class="fc" id="L154">        cliente.resetarTentativasLogin();</span>
<span class="fc" id="L155">        clienteRepository.save(cliente);</span>

<span class="fc" id="L157">        return cliente;</span>
    }

    /**
     * Busca cliente por CPF ou Email
     */
    public Cliente buscarPorCpfOuEmail(String cpfOuEmail) {
        // Primeiro tenta buscar por CPF
<span class="fc" id="L165">        Optional&lt;Cliente&gt; clientePorCpf = clienteRepository.findByCpf(cpfOuEmail);</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">        if (clientePorCpf.isPresent()) {</span>
<span class="fc" id="L167">            return clientePorCpf.get();</span>
        }

        // Se não encontrou por CPF, tenta por email
<span class="fc" id="L171">        Optional&lt;Cliente&gt; clientePorEmail = clienteRepository.findByEmail(cpfOuEmail);</span>
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">        if (clientePorEmail.isPresent()) {</span>
<span class="fc" id="L173">            return clientePorEmail.get();</span>
        }

<span class="nc" id="L176">        throw new RuntimeException(&quot;Cliente não encontrado com CPF/Email: &quot; + cpfOuEmail);</span>
    }

    /**
     * Altera senha do cliente
     */
    public void alterarSenha(Long clienteId, String senhaAtual, String novaSenha) {
<span class="fc" id="L183">        Cliente cliente = buscarPorId(clienteId);</span>

        // Verificar senha atual
<span class="fc bfc" id="L186" title="All 2 branches covered.">        if (!passwordEncoder.matches(senhaAtual, cliente.getSenhaHash())) {</span>
<span class="fc" id="L187">            throw new RuntimeException(&quot;Senha atual incorreta&quot;);</span>
        }

        // Validar nova senha
<span class="pc bpc" id="L191" title="2 of 4 branches missed.">        if (novaSenha == null || novaSenha.trim().isEmpty()) {</span>
<span class="nc" id="L192">            throw new RuntimeException(&quot;A nova senha é obrigatória&quot;);</span>
        }

<span class="pc bpc" id="L195" title="1 of 2 branches missed.">        if (novaSenha.length() &lt; 6) {</span>
<span class="nc" id="L196">            throw new RuntimeException(&quot;A nova senha deve ter no mínimo 6 caracteres&quot;);</span>
        }

        // Criptografar e salvar nova senha
<span class="fc" id="L200">        String novaSenhaHash = passwordEncoder.encode(novaSenha);</span>
<span class="fc" id="L201">        cliente.setSenhaHash(novaSenhaHash);</span>
<span class="fc" id="L202">        cliente.setUpdatedAt(LocalDateTime.now());</span>

<span class="fc" id="L204">        clienteRepository.save(cliente);</span>
<span class="fc" id="L205">    }</span>

    /**
     * Desbloqueia conta de cliente (função administrativa)
     */
    public void desbloquearConta(Long clienteId) {
<span class="fc" id="L211">        Cliente cliente = buscarPorId(clienteId);</span>
<span class="fc" id="L212">        cliente.desbloquearConta();</span>
<span class="fc" id="L213">        clienteRepository.save(cliente);</span>
<span class="fc" id="L214">    }</span>

    /**
     * Busca clientes com contas bloqueadas
     */
    public List&lt;Cliente&gt; buscarContasBloqueadas() {
<span class="fc" id="L220">        return clienteRepository.findByContaBloqueadaTrue();</span>
    }

    /**
     * Busca cliente por email
     */
    public Cliente buscarPorEmail(String email) {
<span class="fc" id="L227">        return clienteRepository.findByEmail(email)</span>
<span class="fc" id="L228">                .orElseThrow(() -&gt; new RuntimeException(&quot;Cliente não encontrado com email: &quot; + email));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>